#!/bin/sh -e

set -e
set -x

SCRIPT_DIR=$(dirname "$0")
. $SCRIPT_DIR/common

#PATH=$PATH:~/.nix-profile/bin

# Default values
TARGET_HOST="pve"

# Parse command line options
while getopts ":i:f:h:" opt; do
  case ${opt} in
    i )
      VMID=$OPTARG
      ;;
    f )
      FLAKE=$OPTARG
      ;;
    h )
      TARGET_HOST=$OPTARG
      ;;
    \? )
      echo "Invalid option: $OPTARG" 1>&2
      ;;
    : )
      echo "Invalid option: $OPTARG requires an argument" 1>&2
      exit 1
      ;;
  esac
done


# Shift off the options and their arguments processed by getopts
shift "$((OPTIND-1))"


# mkdir /tmp/OVERRIDE_ME_PLEASE || true
# echo "{ outputs = {...} : {};}" > /tmp/OVERRIDE_ME_PLEASE/flake.nix
# git init /tmp/OVERRIDE_ME_PLEASE
# git -C /tmp/OVERRIDE_ME_PLEASE add flake.nix

SECRETS_DIR="$HOME/.config/nix-secrets"


# Navigate to the directory of this script
cd $(dirname $(readlink -f $0))
cd ..

echo "${GREEN}Starting build vm ${FLAKE}...${CLEAR}"

# mv -f flake.nix.orig flake.nix || true


# mv flake.nix flake.nix.orig
# mv flake2.nix flake.nix

#nix --experimental-features 'nix-command flakes' build --debugger .#$SYSTEM $@ --override-input secrets "git+file://${SECRETS_DIR}"

#cmdout=$(nix --experimental-features 'nix-command flakes' run  -- github:nix-community/nixos-generators  --format proxmox -c ./flake.nix --flake .#${FLAKE} $@)
nix build .#${FLAKE} --override-input secrets "git+file://${SECRETS_DIR}" $@


echo "${GREEN}Cleaning up...${CLEAR}"
#unlink ./result

#mv flake.lock.orig flake.lock



echo "${GREEN}Installing VM...${CLEAR}"
#./result/activate

VMFILE=$(ls --color='never' result/*.zst)
VMFILEDEST="vzdump-qemu-nixos-${FLAKE}-${VMID}.vma.zst"


scp $VMFILE root@${TARGET_HOST}:/var/lib/vz/dump/${VMFILEDEST}

${SCRIPT_DIR}/vm-reset -i ${VMID} -f ${VMFILEDEST} -h ${TARGET_HOST}


echo "${GREEN}Done${CLEAR}"
